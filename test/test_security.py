import unittest
import zlib
from pathlib import Path

from minimal_pdf_parser.security import ARC4, StandardEncrypterFactory, Encrypter


class SecurityTestCase(unittest.TestCase):
    def test_rc4(self):
        for k, v, cv in [
            (b'Key', b'Plaintext', b'\xbb\xf3\x16\xe8\xd9@\xaf\n\xd3'),
            (b'Wiki', b'pedia', b'\x10!\xbf\x04 '),
            (b'Secret', b'Attack at dawn', b'E\xa0\x1fd_\xc3[85RTK\x9b\xf5')
        ]:
            actual_cv = ARC4(k, v)
            self.assertEqual(cv, actual_cv)
            actual_ccv = ARC4(k, cv)
            self.assertEqual(v, actual_ccv)

    def test_key(self):
        encryption = StandardEncrypterFactory(
            [b'\x95\x97\xc6\x18\xbc\x90\xaf\xa4\xa0x\xcar\xb2\xdd\x06\x1c',
             b'Hr`\x07\xf4\x83\xd5G\xa8\xbe\xffn\x9c\xda\x07/'], 1, 3, 40,
            -28,
            b'c\x98\x16\x88s8r\xde\xc7\x98=<n\xb1\xf4\x12\xccS^\xa2\xda\xa2\xab\x17\x1e+\xbcN6\xb2\x18\x87',
            b"\xd6J\xb1\\t4\xff\xe1s.c\x88'Od\xc4(\xbfN^Nu\x8aAd\x00NV\xff\xfa\x01\x08")
        self.assertEqual(b'\xa9\x05\xe0\xb9\x9c', encryption.create().encryption_key)

    def test_key_pypdf2(self):
        import PyPDF2
        with Path("../fixture/PDF32000_2008.pdf").open("rb") as s:
            reader = PyPDF2.PdfReader(s)
            reader.decrypt("")
            self.assertEqual(b'\xa9\x05\xe0\xb9\x9c',
                             reader._decryption_key)

    def test_decrypter(self):
        data = b'\x9a\xfc,\x16\xe1\xdb\x83\x80\x92\x08\x82\xadz\xa1\xbf?\x04\x7f\xf5\xfa\xbd\xe3~*\xb2Eb\x87NW\xf5\xf5G\x06\xd1\xe6\x80V\x1e\xbc\xbbM\xd1\xd4\xbeV\x04\x90\xb1c\xc9\xc4\x8c\xc6\xed\x12\xdaQV\t\xc1l\xd0\xba8g\x16\xc7RmX\xa9u\xd4\xd9\xd8T\xb8\xa2Iof\xd2\x84d\x86\xc5\xa8\xfa=^K\xd9z/\xbd\xe2W\xb7N\xa4\xa8\xe1\xe7L3^\xc7\xd6\xe1\x06\x89A5@\x0f/\xb2L4\xc3\x8d\xdff\xd17h\x83\xe5j$"6h\xc8\xf2\xc4NF\x9f\xb5L\xbd\\\x94\x8f({\xc2w/\x02!\xe3\x9f\x96\xfd\xc5R\x16Ou\x89\xca\xec_Y\xbd\x8b)\xbe\x1c\x0c\x90m\xd5\x13\xe4\xab\xda\xfb\x87M\xb3\xda\x0e9{\x01\xc7M\xbc\xcf\x1c+\xf8\x87B^A\xb5\xc7\xf7\xa7\x10\xbf!\x15iP\x19\xd3\x00\xaf\xfa\xe4\xa1!+r \xaa\x087\xb0\x85\xf0\x92\x855Z\x1f/\xe894\x9dD\x9ffC\x03Q\xc4_\xbchl\x174K\x9b\x06w\x11\xc5od\xa9\x9fZ\x8e\tD\x93O5kX\x16e\x0c^\xe2qR\xae_4=/\x82\x82\xbbM\x05f&\xfc\x10\xb2\x05_\x9e\xb8\x90\xe2\xb3\xd7\xc0A\xdd!E\xceaX\x05\x89\x12X\x8f\xa8\x99\xd2o\x15\xe6\xe6\x84\x11\xc1\x95\x10\xf8\xd1\xb9\xa5\xe2u\xa8\xadXk_\xed\xb0\xd8[\x81\x92\xb3\x90\x82\xb6\x06\x1bG\x7f\xf0\xfdJCmBdF\x87\'_\xf4\x94>Z%\xbe\x8c\x19"\xfc~M1\xf62\xb4\xfb\xd5\xa0/\x05\x86M\xcfH\xf4\xe1\x98\xac\xd0\xe2X\x85\xca\xa4\xf4X\xdbw\xffp\xb2Xc\x93\xd0\xf5g\xbb\x12\xad\xac\xe9[,6V\xeb\x98\'\x03\x98{\xadV\xce\x1aD\x8d\xf1\xe5vw\xd3O\x16\xe4\xca\x02\x1a\xf2D\xb9\xbdI\x1f)\xd8i\xc5V\x96\xacN\xd4"K\xa9\xa6e\x82\xa32X} \xca11&\xe0\xf5\xea\'GY&\xc1\x85\xb2c\x9d\x1e\x0c2}_}%n\xeb\xa4\x9fZ\x7f\xc1\xb0\x02w\xea\xc2in\xbe\x9b;\x83\xdf\xcd\xe3\xc5\xd8c\xf4\x80\x9f\xd6\xa1\x91\n/\xadOr\x06n(\x840\x9e\xe34#\xaaOwwb\x8e\x031\xef'
        ddata = b'H\x89\x9c\x94]k\xdb0\x14\x86\xef\xf3+\xce\xa5taE\xe7X\x96\xa5R\ni\x93\x8e\x0e\n\x85\xf8n\x1d\xc3\x8d\x9d\xcc#\xb1\x8b\xe3m\xf4\xdfORb\'a\xf56F@96\xe7\xe3}\x8e_\xfb6\x9bLgmW\xad\xf3U\x07\xd7\xd7\xd3\xec\xed\xb5\x84\xe9S\xbe\xa9\xea\xbc\xab\x9a\x1annn\xe7w0\x99~XJ\xd8\xec\'\xd3\x0c\xbfH@\xc8\xd6\x13)\xa4L\x15d+H\x855 \xdd/\x04\xa9\x14\x06b-\x8c\x941d\xbb\t{\xa6\x04\x81g\xdfB1\x9e\x8a\xa5\xf5\xc5Q\x08\t\xb2\x9f\x80\xb2ot\x88R#\xac>o\xf5\x89\xcd\x8a\xe6\xa5\x84\xe5\xdb\x9e\'\xac\xe3\xc8\xca\xdd\x1e\x1e\xea\x95\xbbj\xda\xd7\xa6\xcd\xbb\xb2p1\x90t\xa74\xf0L\xa4a\xb6\xddB[m\xbev\xbe\x08\xdar_\xb6<\xb2\xec\x87K\xfd\x9c}\xbc@\xf2\x82\xa4\x97b\xfdd\xaf$\x04I\xa2\x05]0U\xff\xc3\xa3\xb4\x12VAjI\xa0\xea\x89\x9e\xe6\xf7\x10\x93\x0c\x82#\xbc:D&([<\xfa\xcd/_\xf3\xda?\x9a\xc7\xbb\x87\xb9ku| ~\n\x05\xb9.\x88\xf1\x1d\xcdR\n"\xd0i"H\xf7\xc3\xee\xab\x96\xa3a{\x1e\x91[\x9fb\xb0(*\xff_5nh=6\x14\xfb\xa1\x81\r\xcd\xb0%\x14\x86\x12\x88Ph\xb7\xeb\xacp\x03\xdc\xe2#\xed6\xef\xcf(\r\xa7?p\xac5\x9d\xf3`<,\x10\x03\x11&=\xd2!\n\xd6\xd2\xa8\x04\r\xeb\x9b7\xab\xef\xbb\xb2\xee`\x97\xd797l\xc3#\xc3J\xe7\x0c\x7fslj<L\x1dPXp\xe8;\xb9\xaa\xcfE\x87\x19[\x9f]xOS:R\x90\xf4\x05\xa3-\xf5\x05\xb4>A+\xaf\xc4Y\x82+t~\xe6\x11\xda\xf0\x94\xf2\x17\x8e\xc8\xb6%\x14=\xec\x9aS\xec2v\xf9(b\xfa;"\xc6B\xdb\x1e`L\x9b\x19\xd4\xff\x01\xd1\x0e;\x11d\xe8/\x1dQ\x9e\xdb\x87R{t-\x19<\xe2\xe6\xce\x8e\x869^\xe5y#\xb2\x0c0\xdc\xba:\\\x04\xc6\xb0\xa0\xd3\x0bf|mDZh\xf2\x06D\x13\x0c\x18\xde&\x14\'\xdd\x8b\x7f\xfc\xbe\x85\xe4_\x02\x0c\x00 P-\x1a'
        value = b'BT\n/Artifact <</Type /Pagination >>BDC \n/GS0 gs\n/T1_0 1 Tf\n0.0074 Tc 7.98 0 0 7.98 70.8 36.8003 Tm\n(\\251 )Tj\n/T1_1 1 Tf\n0.0009 Tc -0.0002 Tw 10.98 0 0 10.98 78.96 36.8003 Tm\n[(Adobe Sys)5(t)1(ems Inc)5(orporated)5( 20)5(08 \\226 All rights)5( reser)-9(ved)]TJ\n/T1_0 1 Tf\n0 Tc 0 Tw 9.96 0 0 9.96 556.2 36.8003 Tm\n(i)Tj\n/T1_1 1 Tf\n0.0009 Tc -0.0002 Tw 10.98 0 0 10.98 464.94 792.1403 Tm\n[(PDF 3200)5(0-1:200)5(8)]TJ\nEMC \n/Span <</MCID 0 >>BDC \n0.002 Tc 0.0031 Tw 9.96 0 0 9.96 500.22 675.2603 Tm\n[(Fir)18(s)-2(t)4( Edit)4(io)5(n)]TJ\nEMC \n/Span <</MCID 1 >>BDC \n-0.0018 Tc 0 Tw 1.825 -1.608 Td\n[(20)-6(08)-6(-7)-6(-)-6(1)]TJ\nEMC \n/Span <</MCID 2 >>BDC \n0.0013 Tc -0.0011 Tw 15.96 0 0 15.96 70.8 614.2403 Tm\n[(Document mana)8(g)-8(e)1(ment)]TJ\nEMC \n/Span <</MCID 3 >>BDC \n0 Tc 0 Tw ( )Tj\nEMC \n/Span <</MCID 4 >>BDC \n11.639 0 Td\n(\\227)Tj\nEMC \n/Span <</MCID 5 >>BDC \n( )Tj\nEMC \n/Span <</MCID 6 >>BDC \n0.0016 Tc -0.0014 Tw [(P)41(or)-19(t)4(ab)11(le self f)23(ormat)]TJ\nEMC \n/Span <</MCID 7 >>BDC \n0 Tc 0 Tw 13.699 0 Td\n( )Tj\nEMC \n/Span <</MCID 8 >>BDC \n(\\227)Tj\nEMC \n/Span <</MCID 9 >>BDC \n1.282 0 Td\n( )Tj\nEMC \n/Span <</MCID 10 >>BDC \n-0.0279 Tc 0.0281 Tw [(Pa)-28(r)-49(t)-29( 1)-28(:)-29( )]TJ\n0.001 Tc -0.0008 Tw -26.62 -1.188 Td\n(PDF 1.7)Tj\nEMC \nET\n/Artifact <</Type /Pagination >>BDC \nEMC \n'

        encrypter = Encrypter(b'\xa9\x05\xe0\xb9\x9c', 1)
        self.assertEqual(b'\xdf\\5\xca\x95\x85\xe0"W\xdb', encrypter.get_rc4_key(11, 0))
        self.assertEqual(ddata, encrypter.encrypt_data(11, 0, data))
        self.assertEqual(value, zlib.decompress(ddata))

    def test_chunks(self):
        data = b'\x9a\xfc,\x16\xe1\xdb\x83\x80\x92\x08\x82\xadz\xa1\xbf?\x04\x7f\xf5\xfa\xbd\xe3~*\xb2Eb\x87NW\xf5\xf5G\x06\xd1\xe6\x80V\x1e\xbc\xbbM\xd1\xd4\xbeV\x04\x90\xb1c\xc9\xc4\x8c\xc6\xed\x12\xdaQV\t\xc1l\xd0\xba8g\x16\xc7RmX\xa9u\xd4\xd9\xd8T\xb8\xa2Iof\xd2\x84d\x86\xc5\xa8\xfa=^K\xd9z/\xbd\xe2W\xb7N\xa4\xa8\xe1\xe7L3^\xc7\xd6\xe1\x06\x89A5@\x0f/\xb2L4\xc3\x8d\xdff\xd17h\x83\xe5j$"6h\xc8\xf2\xc4NF\x9f\xb5L\xbd\\\x94\x8f({\xc2w/\x02!\xe3\x9f\x96\xfd\xc5R\x16Ou\x89\xca\xec_Y\xbd\x8b)\xbe\x1c\x0c\x90m\xd5\x13\xe4\xab\xda\xfb\x87M\xb3\xda\x0e9{\x01\xc7M\xbc\xcf\x1c+\xf8\x87B^A\xb5\xc7\xf7\xa7\x10\xbf!\x15iP\x19\xd3\x00\xaf\xfa\xe4\xa1!+r \xaa\x087\xb0\x85\xf0\x92\x855Z\x1f/\xe894\x9dD\x9ffC\x03Q\xc4_\xbchl\x174K\x9b\x06w\x11\xc5od\xa9\x9fZ\x8e\tD\x93O5kX\x16e\x0c^\xe2qR\xae_4=/\x82\x82\xbbM\x05f&\xfc\x10\xb2\x05_\x9e\xb8\x90\xe2\xb3\xd7\xc0A\xdd!E\xceaX\x05\x89\x12X\x8f\xa8\x99\xd2o\x15\xe6\xe6\x84\x11\xc1\x95\x10\xf8\xd1\xb9\xa5\xe2u\xa8\xadXk_\xed\xb0\xd8[\x81\x92\xb3\x90\x82\xb6\x06\x1bG\x7f\xf0\xfdJCmBdF\x87\'_\xf4\x94>Z%\xbe\x8c\x19"\xfc~M1\xf62\xb4\xfb\xd5\xa0/\x05\x86M\xcfH\xf4\xe1\x98\xac\xd0\xe2X\x85\xca\xa4\xf4X\xdbw\xffp\xb2Xc\x93\xd0\xf5g\xbb\x12\xad\xac\xe9[,6V\xeb\x98\'\x03\x98{\xadV\xce\x1aD\x8d\xf1\xe5vw\xd3O\x16\xe4\xca\x02\x1a\xf2D\xb9\xbdI\x1f)\xd8i\xc5V\x96\xacN\xd4"K\xa9\xa6e\x82\xa32X} \xca11&\xe0\xf5\xea\'GY&\xc1\x85\xb2c\x9d\x1e\x0c2}_}%n\xeb\xa4\x9fZ\x7f\xc1\xb0\x02w\xea\xc2in\xbe\x9b;\x83\xdf\xcd\xe3\xc5\xd8c\xf4\x80\x9f\xd6\xa1\x91\n/\xadOr\x06n(\x840\x9e\xe34#\xaaOwwb\x8e\x031\xef'
        ddata = b'H\x89\x9c\x94]k\xdb0\x14\x86\xef\xf3+\xce\xa5taE\xe7X\x96\xa5R\ni\x93\x8e\x0e\n\x85\xf8n\x1d\xc3\x8d\x9d\xcc#\xb1\x8b\xe3m\xf4\xdfORb\'a\xf56F@96\xe7\xe3}\x8e_\xfb6\x9bLgmW\xad\xf3U\x07\xd7\xd7\xd3\xec\xed\xb5\x84\xe9S\xbe\xa9\xea\xbc\xab\x9a\x1annn\xe7w0\x99~XJ\xd8\xec\'\xd3\x0c\xbfH@\xc8\xd6\x13)\xa4L\x15d+H\x855 \xdd/\x04\xa9\x14\x06b-\x8c\x941d\xbb\t{\xa6\x04\x81g\xdfB1\x9e\x8a\xa5\xf5\xc5Q\x08\t\xb2\x9f\x80\xb2ot\x88R#\xac>o\xf5\x89\xcd\x8a\xe6\xa5\x84\xe5\xdb\x9e\'\xac\xe3\xc8\xca\xdd\x1e\x1e\xea\x95\xbbj\xda\xd7\xa6\xcd\xbb\xb2p1\x90t\xa74\xf0L\xa4a\xb6\xddB[m\xbev\xbe\x08\xdar_\xb6<\xb2\xec\x87K\xfd\x9c}\xbc@\xf2\x82\xa4\x97b\xfdd\xaf$\x04I\xa2\x05]0U\xff\xc3\xa3\xb4\x12VAjI\xa0\xea\x89\x9e\xe6\xf7\x10\x93\x0c\x82#\xbc:D&([<\xfa\xcd/_\xf3\xda?\x9a\xc7\xbb\x87\xb9ku| ~\n\x05\xb9.\x88\xf1\x1d\xcdR\n"\xd0i"H\xf7\xc3\xee\xab\x96\xa3a{\x1e\x91[\x9fb\xb0(*\xff_5nh=6\x14\xfb\xa1\x81\r\xcd\xb0%\x14\x86\x12\x88Ph\xb7\xeb\xacp\x03\xdc\xe2#\xed6\xef\xcf(\r\xa7?p\xac5\x9d\xf3`<,\x10\x03\x11&=\xd2!\n\xd6\xd2\xa8\x04\r\xeb\x9b7\xab\xef\xbb\xb2\xee`\x97\xd797l\xc3#\xc3J\xe7\x0c\x7fslj<L\x1dPXp\xe8;\xb9\xaa\xcfE\x87\x19[\x9f]xOS:R\x90\xf4\x05\xa3-\xf5\x05\xb4>A+\xaf\xc4Y\x82+t~\xe6\x11\xda\xf0\x94\xf2\x17\x8e\xc8\xb6%\x14=\xec\x9aS\xec2v\xf9(b\xfa;"\xc6B\xdb\x1e`L\x9b\x19\xd4\xff\x01\xd1\x0e;\x11d\xe8/\x1dQ\x9e\xdb\x87R{t-\x19<\xe2\xe6\xce\x8e\x869^\xe5y#\xb2\x0c0\xdc\xba:\\\x04\xc6\xb0\xa0\xd3\x0bf|mDZh\xf2\x06D\x13\x0c\x18\xde&\x14\'\xdd\x8b\x7f\xfc\xbe\x85\xe4_\x02\x0c\x00 P-\x1a'
        value = b'BT\n/Artifact <</Type /Pagination >>BDC \n/GS0 gs\n/T1_0 1 Tf\n0.0074 Tc 7.98 0 0 7.98 70.8 36.8003 Tm\n(\\251 )Tj\n/T1_1 1 Tf\n0.0009 Tc -0.0002 Tw 10.98 0 0 10.98 78.96 36.8003 Tm\n[(Adobe Sys)5(t)1(ems Inc)5(orporated)5( 20)5(08 \\226 All rights)5( reser)-9(ved)]TJ\n/T1_0 1 Tf\n0 Tc 0 Tw 9.96 0 0 9.96 556.2 36.8003 Tm\n(i)Tj\n/T1_1 1 Tf\n0.0009 Tc -0.0002 Tw 10.98 0 0 10.98 464.94 792.1403 Tm\n[(PDF 3200)5(0-1:200)5(8)]TJ\nEMC \n/Span <</MCID 0 >>BDC \n0.002 Tc 0.0031 Tw 9.96 0 0 9.96 500.22 675.2603 Tm\n[(Fir)18(s)-2(t)4( Edit)4(io)5(n)]TJ\nEMC \n/Span <</MCID 1 >>BDC \n-0.0018 Tc 0 Tw 1.825 -1.608 Td\n[(20)-6(08)-6(-7)-6(-)-6(1)]TJ\nEMC \n/Span <</MCID 2 >>BDC \n0.0013 Tc -0.0011 Tw 15.96 0 0 15.96 70.8 614.2403 Tm\n[(Document mana)8(g)-8(e)1(ment)]TJ\nEMC \n/Span <</MCID 3 >>BDC \n0 Tc 0 Tw ( )Tj\nEMC \n/Span <</MCID 4 >>BDC \n11.639 0 Td\n(\\227)Tj\nEMC \n/Span <</MCID 5 >>BDC \n( )Tj\nEMC \n/Span <</MCID 6 >>BDC \n0.0016 Tc -0.0014 Tw [(P)41(or)-19(t)4(ab)11(le self f)23(ormat)]TJ\nEMC \n/Span <</MCID 7 >>BDC \n0 Tc 0 Tw 13.699 0 Td\n( )Tj\nEMC \n/Span <</MCID 8 >>BDC \n(\\227)Tj\nEMC \n/Span <</MCID 9 >>BDC \n1.282 0 Td\n( )Tj\nEMC \n/Span <</MCID 10 >>BDC \n-0.0279 Tc 0.0281 Tw [(Pa)-28(r)-49(t)-29( 1)-28(:)-29( )]TJ\n0.001 Tc -0.0008 Tw -26.62 -1.188 Td\n(PDF 1.7)Tj\nEMC \nET\n/Artifact <</Type /Pagination >>BDC \nEMC \n'

        encrypter = Encrypter(b'\xa9\x05\xe0\xb9\x9c', 1)
        self.assertEqual(b'\xdf\\5\xca\x95\x85\xe0"W\xdb', encrypter.get_rc4_key(11, 0))
        ec = encrypter.chunks_encrypter(11, 0)
        self.assertEqual(ddata[:20], ec.chunk(data[:20]))

        ec = encrypter.chunks_encrypter(11, 0)
        self.assertEqual(ddata[:10], ec.chunk(data[:10]))
        self.assertEqual(ddata[10:20], ec.chunk(data[10:20]))


if __name__ == "__main__":
    unittest.main()
